<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>Hello World!</title>
        <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />

        <script>let $ = require('jquery');</script>
        <link rel="stylesheet" type="text/css" href="./style.css">

        <!-- Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
        <!--    -->

        <!-- Scripts -->
        <script src="formatting.js"></script>
    </head>
    <body>
        <script type="text/javascript">
            var mysql = require('mysql');
            const fs = require('fs');

            var IP_ADDRESS, USER, PASSWORD, DATABASE_NAME;
            var CONNECTION;
            var DATA;

            var GET_ALL_TUTORS_INFO = 'call sp_get_tutors_in_info(null, null);';
            var GET_TUTORS_IN_FOR_CLASS = 'call sp_get_tutors_in_info(null, ?);';
            var GET_CLASSES_TUTORED = 'call sp_get_classes_tutored();'
            var GET_TUTORS_FOR_SUBJECT = "call sp_get_tutors_for_subject(?);"
            var GET_TUTORS_IN = "call sp_get_tutors_in(null);"

            var SELECTED_TUTOR = null;


            fs.readFile('./con.data', 'utf8', (err, data) => {
                if (err) {
                    console.error(err)
                    return
                }

                data = data.split(/\r?\n/);

                IP_ADDRESS = data[0];
                USER = data[1];
                PASSWORD = data[2];
                DATABASE_NAME = data[3];
            });

            $(document).ready(function() {
                $('#tutor_list').click(function() {
                    fnCreateLoadingScreen('info-grid', 'Loading Tutor Data');
                    fnRunQuery(GET_ALL_TUTORS_INFO, fnFillData, fnTutorList, 'info-grid');
                    $('#table-header')[0].innerHTML = "Tutors"
                });

                $('#class_list').click(function() {
                    fnCreateLoadingScreen('info-grid', 'Loading Class Data');
                    fnRunQuery(GET_CLASSES_TUTORED, fnFillData, fnClassClicked, 'info-grid');
                    $('#table-header')[0].innerHTML = "Classes"
                });

                $('#check_in_list').click(function() {
                    $("#m_login").show();
                    fnCreateLoadingScreen('m_info-content', 'Finding Tutors');
                    fnRunQuery(GET_TUTORS_IN, fnFillData, fnSelectTutor, 'm_info-content');
                    $('#m_login-title')[0].innerHTML = "Tutors In"
                });

            });

            function fnSelectTutor(e) {
                if(SELECTED_TUTOR != fnGetTextFromRow(e)[0])
                    SELECTED_TUTOR = fnGetTextFromRow(e)[0];
                else
                    SELECTED_TUTOR = null;
            }

            $(function(){
                $("#modal-container").load("./modal.html");
            });

            function fnCreateConnection() {
                // Add the credentials to access your database
                CONNECTION = mysql.createConnection({
                    host     : IP_ADDRESS,
                    user     : USER,
                    password : PASSWORD,
                    database : DATABASE_NAME
                });

                CONNECTION.connect();

            }

            function fnCloseConnection() {
                CONNECTION.end();
            }

            function fnRunQuery(strQuery, fncallback, ...rest) {
                fnCreateConnection();

                CONNECTION.query(strQuery, function(err, rows, fields) {
                    if (err) throw err;

                    // If it's a stored procedure, it has to act slightly differently
                    if(/^call [A-Za-z_0-9]+\(.*\);$/.test(strQuery))
                        rows = rows[0];

                    fncallback(rows, fields, rest);
                });

                fnCloseConnection();
            }

            function fnLog() {
                if(typeof(console) !== 'undefined') {
                    console.log.apply(console, arguments);
                }
            }

        </script>

        <script type="text/javascript">
            function fnEnterNum(item) {
                if(item.name == "clear") $("#id_login")[0].value = "";
                else if(item.name == "enter") {
                    if($("#id_login")[0].value.length == 0) {
                        fnFlash();
                        return;
                    }
                    var temp = $("#id_login")[0].value;
                    $("#id_login")[0].value = "";

                    var CHECK_IN_STUDENT = `call sp_student_in(${SELECTED_TUTOR},${temp},null);`;
                    // var query = mysql.format(CHECK_IN_STUDENT, [, temp]);

                    fnRunQuery(CHECK_IN_STUDENT, function(...rest){
                        console.log();
                        if(rest[0][0]['Output'] === -1) {
                            fnFlash();
                        } else {
                            clearloginModal(true);
                        }
                    });

                    console.log(temp);
                }
                else if ($("#id_login")[0].value.length < 9){
                    $("#id_login")[0].value += item.innerHTML;
                }
                else {
                    fnFlash();
                }
            }

            function fnFlash() {
                $("#id_login").addClass('warning');
                setTimeout(function() {
                    $("#id_login").removeClass("warning");
                }, 250);
                // alert("That was an invalid id number.\nPlease try again");
            }

            function fnClassClicked(e) {
                clearInfoModal(false);
                fnCreateLoadingScreen('m_info-content-right', 'Loading Class Data');
                $("#m_info").show();
                var classID = e[0].innerText.match(/^[a-zA-Z]+\s[0-9]+L?/g)[0];

                // Need to figure out how to escape characters
                var query = mysql.format(GET_TUTORS_IN_FOR_CLASS, [classID])
                $('#m_info-title').text(`Tutors for ${classID}`);
                fnRunQuery(query, fnFillData, fnTutorList, 'm_info-content-right');
            }
        </script>
        <!-- <h1>Student Information</h1>
        <div id='grid1' class="table-container"></div>
        <h1>Tutor Information</h1>
        <div id='grid2' class="table-container"></div> -->

        <div class="main-title">
            <h1 class="main-title">Tutoring Database</h1>
        </div>
        <div class="main-screen-container">
            <div class="login-buttons">
                <!-- Info -->
                <button type="button" id="tutor_list" name="tutor_list" class="normal">Tutor List</button>
                <br/>
                <button type="button" id="class_list" name="class_list" class="normal">Class List</button>
                <br/>
                <button type="button" id="check_in_list" name="avail_tut_list" class="normal">Check In</button>
            </div>
            <div class="info-panel">
                <h1 id="table-header"></h1>
                <div id='info-grid' class="table-container">
                </div>
            </div>
        </div>
        <div id='modal-container'></div>
    </body>
</html>
